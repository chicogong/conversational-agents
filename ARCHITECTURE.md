# 会话代理架构

本文档描述了会话代理应用程序中解耦服务的架构。

## 概述

应用程序已重构为一个模块化架构，将主要组件分开：

1. **WebSocket 服务**：处理客户端连接和消息路由
2. **ASR 服务**：处理自动语音识别
3. **TTS 服务**：处理文本转语音
4. **LLM 服务**：利用语言模型处理用户输入
5. **日志服务**：为所有服务提供日志功能

这种解耦使得应用程序更容易维护、测试和扩展。

## 服务架构

```
┌─────────────────┐                          ┌─────────────────┐
│                 │                          │                 │
│  WebSocket      │◄────────────────────────►│  LLM Service    │
│  Service        │                          │                 │
│                 │                          │                 │
└───────┬─────────┘                          └────────┬────────┘
        │                                             │
        │                                             │
        │                                             │
        │                                             │
        │                                             │
        │                                             │
        ▼                                             ▼
┌─────────────────┐     ┌──────────────────┐    ┌────────────────┐
│                 │     │                  │    │                │
│     Client      │◄────┤  ASR Service     │    │  TTS Service   │
│    Browser      │────►│                  │    │                │
│                 │     │                  │    │                │
└─────────────────┘     └──────────────────┘    └────────────────┘
        ▲                        │                     ▲
        │                        │                     │
        │                        ▼                     │
        │                 ┌──────────────┐             │
        │                 │              │             │
        └─────────────────┤ Azure Speech ├─────────────┘
                          │  Services    │
                          │              │
                          └──────────────┘
                                 ▲
                                 │
                                 │
                                 ▼
                         ┌───────────────┐
                         │               │
                         │  OpenAI API   │
                         │               │
                         └───────────────┘
```

## 服务职责

### WebSocket 服务 (`wsHandler.js`)

- 管理与客户端的 WebSocket 连接
- 将消息路由到适当的服务
- 为其他服务提供通信工具
- 维护连接状态和上下文

### ASR 服务 (`asrService.js`)

- 管理 Azure Speech SDK 集成用于语音识别
- 处理用于语音识别的音频流
- 处理音频数据以检测语音活动
- 提供实时语音识别

### TTS 服务 (`ttsService.js`)

- 管理 Azure Speech SDK 集成用于文本转语音
- 处理 SSML 构建和语音合成
- 管理逐句文本到语音的处理队列
- 处理音频格式和流式传输

### LLM 服务 (`llmService.js`)

- 集成 OpenAI API
- 维护会话历史
- 用语言模型处理用户输入
- 将 LLM 响应流式传输回客户端
- 处理响应分段用于 TTS

### 日志服务 (`logger.js`)

- 为所有组件提供结构化日志
- 按类别（websocket、llm、speech）分离日志
- 处理控制台和文件日志
- 支持日志系统的优雅关闭

## 连接上下文

每个 WebSocket 连接维护一个上下文对象来存储服务特定的状态：

```javascript
ws.context = {
  // 所有服务共享的上下文对象
  llm: {
    conversationHistory: null,
    stream: null
  },
  speech: {
    recognizer: null,
    pushStream: null,
    audioConfig: null,
    synthesizer: null
  }
};
```

这允许服务维护其状态，同时保持实现细节封装。

## 解耦架构的好处

1. **可维护性**：每个服务都有明确定义的职责，使代码更容易维护
2. **可测试性**：可以单独测试服务
3. **可扩展性**：可以在对现有代码影响最小的情况下添加新功能
4. **可扩展性**：如果需要，服务可以移动到单独的进程甚至机器
5. **弹性**：一个服务中的问题不太可能影响其他服务

## 未来改进

解耦架构为未来的增强提供了基础：

1. 使用事件发射器进一步隔离服务
2. 支持多个 LLM 提供商
3. 高级语音活动检测
4. 替代语音识别提供商
5. 服务特定的配置和扩展 